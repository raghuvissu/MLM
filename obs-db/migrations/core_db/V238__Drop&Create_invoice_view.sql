Drop view if exists billdetails_v;

CREATE VIEW `billdetails_v` AS select `b`.`client_id` AS `client_id`,`a`.`id` AS `transId`,`b`.`invoice_date` AS `transDate`,'SERVICE_CHARGES' AS `transType`,`a`.`netcharge_amount` AS `amount`,concat(date_format(`a`.`charge_start_date`,'%Y-%m-%d'),' to ',date_format(`a`.`charge_end_date`,'%Y-%m-%d')) AS `description`,`c`.`plan_id` AS `plan_code`,`a`.`charge_type` AS `service_code` from ((`b_charge` `a` join `b_bill_item` `b`) join `b_orders` `c`) where ((`a`.`billitem_id` = `b`.`id`) and (`a`.`order_id` = `c`.`id`) and isnull(`a`.`bill_id`) and (`b`.`invoice_date` <= now()) and (`a`.`priceline_id` >= 1)) union all select `b`.`client_id` AS `client_id`,`a`.`id` AS `transId`,date_format(`b`.`invoice_date`,'%Y-%m-%d') AS `transDate`,'TAXES' AS `transType`,`a`.`tax_amount` AS `amount`,`a`.`tax_code` AS `description`,NULL AS `plan_code`,`c`.`charge_type` AS `service_code` from ((`b_charge_tax` `a` join `b_bill_item` `b`) join `b_charge` `c`) where ((`a`.`billitem_id` = `b`.`id`) and (`a`.`charge_id` = `c`.`id`) and isnull(`a`.`bill_id`) and (`b`.`invoice_date` <= now())) union all select `obstenant-default`.`b_adjustments`.`client_id` AS `client_id`,`obstenant-default`.`b_adjustments`.`id` AS `transId`,date_format(`obstenant-default`.`b_adjustments`.`adjustment_date`,'%Y-%m-%d') AS `transDate`,'ADJUSTMENT' AS `transType`,(case `obstenant-default`.`b_adjustments`.`adjustment_type` when 'DEBIT' then -(`obstenant-default`.`b_adjustments`.`adjustment_amount`) when 'CREDIT' then `obstenant-default`.`b_adjustments`.`adjustment_amount` end) AS `amount`,`obstenant-default`.`b_adjustments`.`remarks` AS `remarks`,`obstenant-default`.`b_adjustments`.`adjustment_type` AS `adjustment_type`,NULL AS `service_code` from `b_adjustments` where (isnull(`obstenant-default`.`b_adjustments`.`bill_id`) and (`obstenant-default`.`b_adjustments`.`adjustment_date` <= now())) union all select `pa`.`client_id` AS `client_id`,`pa`.`id` AS `transId`,date_format(`pa`.`payment_date`,'%Y-%m-%d') AS `transDate`,concat('PAYMENT',' - ',`p`.`code_value`) AS `transType`,`pa`.`amount_paid` AS `invoiceAmount`,`pa`.`Remarks` AS `remarks`,`p`.`code_value` AS `code_value`,NULL AS `service_code` from (`b_payments` `pa` join `m_code_value` `p`) where (isnull(`pa`.`bill_id`) and (`pa`.`payment_date` <= now()) and (`pa`.`paymode_id` = `p`.`id`)) union all select `b`.`client_id` AS `client_id`,`a`.`id` AS `transId`,date_format(`c`.`sale_date`,'%Y-%m-%d') AS `transDate`,'ONETIME_CHARGES' AS `transType`,`a`.`netcharge_amount` AS `amount`,`c`.`charge_code` AS `charge_code`,`c`.`item_id` AS `item_id`,`a`.`charge_type` AS `service_code` from ((`b_charge` `a` join `b_bill_item` `b`) join `b_onetime_sale` `c`) where ((`a`.`billitem_id` = `b`.`id`) and (`a`.`order_id` = `c`.`id`) and isnull(`a`.`bill_id`) and (`c`.`sale_date` <= now()) and (`c`.`invoice_id` = `b`.`id`) and (`a`.`priceline_id` = 0)) union all select `b`.`client_id` AS `client_id`,`a`.`id` AS `transId`,`b`.`invoice_date` AS `transDate`,'SERVICE_TRANSFER' AS `transType`,`a`.`netcharge_amount` AS `amount`,concat(date_format(`a`.`charge_start_date`,'%Y-%m-%d'),' to ',date_format(`a`.`charge_end_date`,'%Y-%m-%d')) AS `description`,`ph`.`property_code` AS `plan_code`,`a`.`charge_type` AS `service_code` from ((`b_charge` `a` join `b_bill_item` `b`) join `b_property_history` `ph`) where ((`a`.`billitem_id` = `b`.`id`) and (`a`.`order_id` = `ph`.`id`) and isnull(`a`.`bill_id`) and (`b`.`invoice_date` <= now()) and (`a`.`priceline_id` = -(1))) union all select `bdr`.`client_id` AS `client_id`,`bdr`.`id` AS `transId`,date_format(`bdr`.`transaction_date`,'%Y-%m-%d') AS `transDate`,'DEPOSIT&REFUND' AS `transType`,(case when (`bdr`.`description` in ('Deposit','Payment Towards Refund Entry')) then `bdr`.`debit_amount` when (`bdr`.`description` in ('Refund','Refund Adjustment towards Service Balance')) then -(`bdr`.`credit_amount`) end) AS `amount`,`bdr`.`description` AS `remarks`,`bdr`.`transaction_type` AS `transaction`,NULL AS `service_code` from `b_deposit_refund` `bdr` where ((`bdr`.`transaction_date` <= now()) and isnull(`bdr`.`bill_id`));


Drop view if exists clientbal_vw;

  CREATE  VIEW `clientbal_vw` AS select `dt`.`year4` AS `year4`,`dt`.`year_month_abbreviation` AS `year_mon`,`dt`.`month_number` AS `mon`,`dt`.`date_value` AS `date_value`,`c`.`office_id` AS `office_id`,`c`.`id` AS `client_id`,`c`.`display_name` AS `client`,round((select sum(`bi`.`invoice_amount`) AS `inv_amt` from `b_bill_item` `bi` where ((`bi`.`invoice_date` <= `dt`.`date_value`) and (`bi`.`client_id` = `c`.`id`)) group by `bi`.`client_id`),2) AS `inv_amt`,round((select sum(`bp`.`amount_paid`) AS `pmt_amt` from `b_payments` `bp` where ((`bp`.`payment_date` <= `dt`.`date_value`) and (`bp`.`client_id` = `c`.`id`)) group by `bp`.`client_id`),2) AS `pmt_amt` from (`dim_date` `dt` join `m_client` `c`) where (`dt`.`year4` = 2017);
  
  
Drop view if exists cuminv_vw;
  
  CREATE  VIEW `cuminv_vw` AS select `bi`.`id` AS `id`,`bi`.`client_id` AS `client_id`,`bi`.`invoice_date` AS `invoice_date`,`bi`.`invoice_amount` AS `invoice_amount`,(select sum(`bi2`.`invoice_amount`) from `b_bill_item` `bi2` where (`bi2`.`id` <= `bi`.`id`)) AS `cum_inv` from `b_bill_item` `bi` ;
  
 
  
Drop view if exists int_fa_v;
  
   CREATE VIEW `int_fa_v` AS select cast(`i`.`int_date` as date) AS `int_date`,'m_clients' AS `obsTable`,`mc`.`id` AS `client_id`,`mc`.`account_no` AS `id`,cast(`mc`.`activation_date` as date) AS `date`,0 AS `amount`,`mc`.`display_name` AS `details`,'New' AS `transactionType` from (`INT_FA` `i` join `m_client` `mc`) where (`mc`.`id` between `i`.`From_id` and `i`.`to_id`) union all select cast(`i`.`int_date` as date) AS `int_date`,'b_bill_item' AS `obsTable`,`b`.`client_id` AS `client_id`,`b`.`id` AS `id`,cast(`b`.`invoice_date` as date) AS `invoice_date`,(case when (`b`.`invoice_amount` > 0) then concat('+',`b`.`invoice_amount`) when (`b`.`invoice_amount` < 0) then concat('-',abs(`b`.`invoice_amount`)) else 0 end) AS `invoice_amount`,`b`.`invoice_status` AS `invoice_status`,'Invoice' AS `transactionType` from (`INT_FA` `i` join `b_bill_item` `b`) where (`b`.`id` between `i`.`From_id` and `i`.`to_id`) union all select cast(`i`.`int_date` as date) AS `int_date`,'b_payments' AS `obsTable`,`b`.`client_id` AS `client_id`,`b`.`id` AS `id`,cast(`b`.`payment_date` as date) AS `payment_date`,concat('-',round(`b`.`amount_paid`,2)) AS `amount_paid`,`b`.`Remarks` AS `remarks`,'Payment' AS `transactionType` from (`INT_FA` `i` join `b_payments` `b`) where (`b`.`id` between `i`.`From_id` and `i`.`to_id`) union all select cast(`i`.`int_date` as date) AS `int_date`,'b_adjustments' AS `obsTable`,`b`.`client_id` AS `client_id`,`b`.`id` AS `id`,cast(`b`.`adjustment_date` as date) AS `adjustment_date`,(case when (`b`.`adjustment_type` = 'DEBIT') then concat('+',`b`.`adjustment_amount`) when (`b`.`adjustment_type` = 'CREDIT') then concat('-',`b`.`adjustment_amount`) else 0 end) AS `adjustment_amount`,`b`.`adjustment_type` AS `adjustment_type`,'Adjustment' AS `transactionType` from (`INT_FA` `i` join `b_adjustments` `b`) where (`b`.`id` between `i`.`From_id` and `i`.`to_id`);
  
  
  
  
Drop view if exists  invpmt_vw;
  
   CREATE  VIEW `invpmt_vw` AS select 'inv' AS `t`,`obstenant-default`.`b_bill_item`.`client_id` AS `client_id`,`obstenant-default`.`b_bill_item`.`id` AS `id`,cast(`obstenant-default`.`b_bill_item`.`invoice_date` as date) AS `date`,`obstenant-default`.`b_bill_item`.`invoice_amount` AS `amt`,`obstenant-default`.`b_bill_item`.`invoice_amount` AS `inv`,0 AS `pmt` from `b_bill_item` union select 'pmt' AS `t`,`obstenant-default`.`b_payments`.`client_id` AS `client_id`,`obstenant-default`.`b_payments`.`id` AS `id`,cast(`obstenant-default`.`b_payments`.`payment_date` as date) AS `date(payment_date)`,`obstenant-default`.`b_payments`.`amount_paid` AS `amountpaid`,0 AS `0`,`obstenant-default`.`b_payments`.`amount_paid` AS `amount_paid` from `b_payments` order by 1,3; 
   
   
Drop view if exists netrevenueDtls_vw;
   
   CREATE VIEW `netrevenueDtls_vw` AS select `c`.`id` AS `client_id`,`dt`.`year4` AS `year4`,`dt`.`month_number` AS `mon`,`dt`.`year_month_abbreviation` AS `year_mon`,`dt`.`date_value` AS `date`,`fopbal`(`c`.`id`,`dt`.`date_value`) AS `opbal`,`bi`.`id` AS `inv_id`,`bi`.`invoice_date` AS `invoice_date`,sum(round(`bi`.`invoice_amount`,2)) AS `inv_amt`,`bp`.`id` AS `pmt_id`,`bp`.`payment_date` AS `payment_date`,sum(round(ifnull(`bp`.`amount_paid`,0),2)) AS `pmt_amt`,`ldm`.`date_value` AS `month_end`,`fbal`(`c`.`id`,`dt`.`date_value`) AS `fclbal`,`cb`.`balance_amount` AS `current_balance` from (((((`m_client` `c` join `dim_date` `dt` on(((`dt`.`year4` = 2015) and (`dt`.`month_number` <= month(now()))))) join `dim_date` `ldm` on(((`dt`.`year_month_number` = `ldm`.`year_month_number`) and (`ldm`.`is_last_day_in_month` = 'Yes')))) join `b_client_balance` `cb` on((`c`.`id` = `cb`.`client_id`))) left join `b_bill_item` `bi` on(((`c`.`id` = `bi`.`client_id`) and (`bi`.`invoice_date` = `dt`.`date_value`)))) left join `b_payments` `bp` on(((`c`.`id` = `bp`.`client_id`) and (`bp`.`payment_date` = `dt`.`date_value`) and (`bp`.`is_deleted` = 0) and (`dt`.`year_month_number` = convert(concat(year(`bp`.`payment_date`),'-',month(`bp`.`payment_date`)) using utf8))))) where ((`bi`.`id` is not null) or (`bp`.`id` is not null)) group by `bi`.`client_id`,`dt`.`date_value`,`bi`.`id`,`bp`.`id` order by `c`.`id`,`dt`.`year4`,`dt`.`date_value` ;

   
Drop view if exists netrevenue_vw;
   
  CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `netrevenue_vw` AS select `dt`.`year4` AS `year4`,`dt`.`year_month_abbreviation` AS `year_mon`,`dt`.`month_number` AS `mon`,`c`.`id` AS `client_id`,ifnull((select round((sum(`biop`.`invoice_amount`) - ifnull(sum(`bpop`.`amount_paid`),0)),2) AS `op_bal` from (`b_bill_item` `biop` left join `b_payments` `bpop` on((`biop`.`client_id` = `bpop`.`client_id`))) where ((`biop`.`invoice_date` < `fdm`.`date_value`) and (`bpop`.`payment_date` < `fdm`.`date_value`) and (`biop`.`client_id` = `c`.`id`))),0) AS `op_bal`,`bi`.`invoice_amount` AS `inv_amt`,round(ifnull(`bp`.`amount_paid`,0),2) AS `pmt_amt`,`ldm`.`date_value` AS `date_value`,round((select (ifnull(sum(`bicl`.`invoice_amount`),0) - ifnull(sum(`bpcl`.`amount_paid`),0)) AS `cl_bal` from (`b_bill_item` `bicl` left join `b_payments` `bpcl` on((`bicl`.`client_id` = `bpcl`.`client_id`))) where ((`bicl`.`invoice_date` <= `ldm`.`date_value`) and (`bpcl`.`payment_date` <= `ldm`.`date_value`) and (`bicl`.`client_id` = `c`.`id`))),2) AS `cl_bal` from (((((`m_client` `c` join `dim_date` `dt` on(((`dt`.`year4` = 2014) and (`dt`.`month_number` <= month(now()))))) join `dim_date` `fdm` on(((`fdm`.`year_month_number` = `dt`.`year_month_number`) and (`fdm`.`is_first_day_in_month` = 'Yes')))) join `dim_date` `ldm` on(((`dt`.`year_month_number` = `ldm`.`year_month_number`) and (`ldm`.`is_last_day_in_month` = 'Yes')))) join `b_bill_item` `bi` on(((`c`.`id` = `bi`.`client_id`) and (`dt`.`year_month_number` = concat(year(`bi`.`invoice_date`),'-',month(`bi`.`invoice_date`)))))) left join `b_payments` `bp` on(((`c`.`id` = `bp`.`client_id`) and (`dt`.`year_month_number` = concat(year(`bp`.`payment_date`),'-',month(`bp`.`payment_date`)))))) group by `bi`.`client_id`,`dt`.`year_month_abbreviation` order by `c`.`id`,`dt`.`year4`,`dt`.`month_number` ;
	
	
Drop view if exists netrevenue_vw1;
	
   CREATE  VIEW `netrevenue_vw1` AS select `dt`.`year4` AS `year4`,`dt`.`year_month_abbreviation` AS `year_mon`,`dt`.`month_number` AS `mon`,`c`.`id` AS `client_id`,ifnull((select round((sum(`biop`.`invoice_amount`) - ifnull(sum(`bpop`.`amount_paid`),0)),2) AS `op_bal` from (`b_bill_item` `biop` left join `b_payments` `bpop` on((`biop`.`client_id` = `bpop`.`client_id`))) where ((`biop`.`invoice_date` < `fdm`.`date_value`) and (`bpop`.`payment_date` < `fdm`.`date_value`) and (`biop`.`client_id` = `c`.`id`))),0) AS `op_bal`,`bi`.`invoice_amount` AS `inv_amt`,round(ifnull(`bp`.`amount_paid`,0),2) AS `pmt_amt`,`ldm`.`date_value` AS `date_value`,round((select (ifnull(sum(`bicl`.`invoice_amount`),0) - ifnull(sum(`bpcl`.`amount_paid`),0)) AS `cl_bal` from (`b_bill_item` `bicl` left join `b_payments` `bpcl` on((`bicl`.`client_id` = `bpcl`.`client_id`))) where ((`bicl`.`invoice_date` <= `ldm`.`date_value`) and (`bpcl`.`payment_date` <= `ldm`.`date_value`) and (`bicl`.`client_id` = `c`.`id`))),2) AS `cl_bal` from (((((`m_client` `c` join `dim_date` `dt` on(((`dt`.`year4` = 2014) and (`dt`.`month_number` <= month(now()))))) join `dim_date` `fdm` on(((`fdm`.`year_month_number` = `dt`.`year_month_number`) and (`fdm`.`is_first_day_in_month` = 'Yes')))) join `dim_date` `ldm` on(((`dt`.`year_month_number` = `ldm`.`year_month_number`) and (`ldm`.`is_last_day_in_month` = 'Yes')))) join `b_bill_item` `bi` on(((`c`.`id` = `bi`.`client_id`) and (`dt`.`year_month_number` = concat(year(`bi`.`invoice_date`),'-',month(`bi`.`invoice_date`)))))) left join `b_payments` `bp` on(((`c`.`id` = `bp`.`client_id`) and (`dt`.`year_month_number` = concat(year(`bp`.`payment_date`),'-',month(`bp`.`payment_date`)))))) where (`c`.`id` <= 10) group by `bi`.`client_id`,`dt`.`year_month_abbreviation` order by `c`.`id`,`dt`.`year4`,`dt`.`month_number`;
	 

	 
	 
	 
	 
